import { readFileSync } from "node:fs";
import { fileURLToPath } from "node:url";
import { dirname, join } from "node:path";

const __dirname = dirname(fileURLToPath(import.meta.url));
const dataPath = join(__dirname, "../../../data/peruvian_recipes.json");

let DATA = null;
function getData() {
  if (!DATA) {
    const json = JSON.parse(readFileSync(dataPath, "utf-8"));
    DATA = json.items ?? json;
  }
  return DATA;
}

export default function handler(req, res) {
  res.setHeader("Access-Control-Allow-Origin", "*");
  const { id } = req.query;
  const key = id.toString().toLowerCase();

  const data = getData();
  const recipe = data.find(r =>
    String(r.id).toLowerCase() === key || r.slug?.toLowerCase() === key
  );

  if (!recipe) return res.status(404).json({ error: "Not found" });
  return res.status(200).json(recipe);
}
